<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CitiBike NYC: Demand, Risk, and Net Flow Analysis (2023–2025)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Simple styling for a report-like presentation -->
  <style>
    :root {
      --bg: #f7f7fb;
      --fg: #222;
      --accent: #005ea5;
      --accent-soft: #e0f0ff;
      --muted: #666;
      --card-bg: #ffffff;
      --border: #ddd;
      --max-width: 900px;
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: var(--bg);
      color: var(--fg);
      line-height: 1.6;
    }
    header {
      background: white;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    .header-inner {
      max-width: var(--max-width);
      margin: 0 auto;
      padding: 0.75rem 1.25rem;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem 1rem;
    }
    .title-block h1 {
      margin: 0;
      font-size: 1.3rem;
    }
    .title-block p {
      margin: 0;
      font-size: 0.85rem;
      color: var(--muted);
    }
    nav a {
      margin-left: 1rem;
      font-size: 0.85rem;
      text-decoration: none;
      color: var(--muted);
      padding-bottom: 0.2rem;
      border-bottom: 2px solid transparent;
    }
    nav a:hover {
      color: var(--accent);
      border-bottom-color: var(--accent-soft);
    }
    main {
      max-width: var(--max-width);
      margin: 0 auto;
      padding: 1.5rem 1.25rem 3rem;
    }
    section {
      margin-bottom: 2.5rem;
      padding: 1.5rem;
      background: var(--card-bg);
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.03);
      border: 1px solid #eee;
    }
    section h2 {
      margin-top: 0;
      font-size: 1.4rem;
      border-bottom: 1px solid var(--border);
      padding-bottom: 0.4rem;
    }
    h3 {
      margin-top: 1.4rem;
      font-size: 1.1rem;
    }
    h4 {
      margin-top: 1rem;
      font-size: 1rem;
    }
    p {
      margin-top: 0.6rem;
      margin-bottom: 0.6rem;
    }
    ul {
      margin-top: 0.4rem;
      padding-left: 1.3rem;
    }
    li {
      margin-bottom: 0.3rem;
    }
    .callout {
      border-left: 3px solid var(--accent);
      padding-left: 0.8rem;
      margin: 0.8rem 0;
      background: var(--accent-soft);
      border-radius: 4px;
      padding-top: 0.6rem;
      padding-bottom: 0.6rem;
    }
    .tagline {
      font-size: 0.9rem;
      color: var(--muted);
    }
    .figure {
      margin: 1rem 0;
      text-align: center;
      font-size: 0.9rem;
      color: var(--muted);
    }
    .figure img {
      max-width: 100%;
      border-radius: 8px;
      border: 1px solid #eee;
    }
    code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.85rem;
      background: #f0f0f5;
      padding: 0.1rem 0.3rem;
      border-radius: 3px;
    }
    .pill-list {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-top: 0.5rem;
    }
    .pill {
      font-size: 0.8rem;
      padding: 0.2rem 0.6rem;
      border-radius: 999px;
      border: 1px solid #ddd;
      background: #fafafa;
    }
    @media (max-width: 600px) {
      nav {
        width: 100%;
        display: flex;
        flex-wrap: wrap;
        gap: 0.4rem;
      }
      nav a {
        margin-left: 0;
        margin-right: 1rem;
      }
    }
  </style>

  <!-- MathJax 3 configuration for LaTeX support -->
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true
      },
      svg: { fontCache: 'global' }
    };
  </script>
  <script id="MathJax-script" async
          src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
</head>
<body>

<header>
  <div class="header-inner">
    <div class="title-block">
      <h1>CitiBike NYC: Demand, Risk, and Net Flow (2023–2025)</h1>
      <p class="tagline">Exploring how CitiBike usage and crash risk data can create value for CitiBike and an insurance partner.</p>
    </div>
    <nav>
      <a href="#overview">Overview</a>
      <a href="#data-analysis">Data Analysis</a>
      <a href="#risk-analysis">Risk Analysis</a>
      <a href="#net-flow">Net Flow Prediction</a>
      <a href="#conclusion">Conclusion</a>
    </nav>
  </div>
</header>

<main>

  <!-- 1. Overview -->
  <section id="overview">
    <h2>1. CitiBike &amp; Project Overview</h2>

    <h3>1.1 CitiBike in New York City</h3>
    <p>
      CitiBike is New York City’s largest bike sharing system with thousands of bikes
      and a dense network of stations across Manhattan, Brooklyn, Queens, parts of the Bronx,
      and Jersey City. For many trips, CitiBike is a realistic alternative to public transport,
      ride-hailing, or private car use.
    </p>
    <p>
      This project uses CitiBike trip data (January 2023–October 2025) jointly with NYPD collision data to:
    </p>
    <ul>
      <li>understand how and where CitiBike is used,</li>
      <li>quantify safety risk around stations using a transparent risk measure, and</li>
      <li>explore how these insights can support <strong>insurance products</strong> and <strong>operational decisions</strong>.</li>
    </ul>

    <h3>1.2 Data &amp; Time Frame</h3>
    <ul>
      <li><strong>Usage data:</strong> CitiBike trip records (start and end station, timestamps, trip duration, bike type, user type).</li>
      <li><strong>Crash data:</strong> NYPD collision records with detailed information on injuries, fatalities, and vehicles involved.</li>
      <li><strong>Geospatial data:</strong> Station locations and, where necessary, cleaned/merged station identifiers.</li>
    </ul>

    <div class="callout">
      <strong>Key idea:</strong> CitiBike trip data gives us exposure (how often and where bikes are used),
      while crash data provides information on severity. Combining both allows us to construct
      a <em>risk per trip</em> measure that is meaningful for users, CitiBike, and a potential insurer.
    </div>

    <h3>1.3 Structure of the Presentation</h3>
    <p>
      The remainder of this webpage is organized as follows:
    </p>
    <ul>
      <li><strong>Section 2 – Data Analysis:</strong> How demand evolves over time, across space, and by user type.</li>
      <li><strong>Section 3 – Risk Analysis:</strong> How we construct and interpret a station-level and time-of-day risk measure.</li>
      <li><strong>Section 4 – Net Flow Prediction:</strong> How predictive models can support rebalancing and capacity planning.</li>
      <li><strong>Section 5 – Conclusion:</strong> Strategic takeaways and implications for an insurance partnership.</li>
    </ul>
  </section>

  <!-- 2. Data Analysis -->
<section id="data-analysis">
  <h2>2. Data Analysis: CitiBike (2023–2025)</h2>

  <p>
    This section analyzes CitiBike usage from 2023–2025 along four dimensions:
    (i) overall demand, (ii) net flow, (iii) usage patterns by bike type, user type,
    weekday/weekend and hour of day, and (iv) trip duration and distance.
    The goal is to understand how the system is used, how it has changed over time,
    and where value can be created.
  </p>

  <!-- 2.1 Demand (from notebook: "1. Demand") -->
  <h3>2.1 Demand</h3>

  <p>
    To understand overall demand and its evolution, we look at daily CitiBike usage
    and average daily demand per station, both smoothed using a 30-day rolling mean.
  </p>

  <div class="figure">
    <!-- export your figure from the notebook and reference it here -->
    <!-- <img src="src/figures/daily_usage_rolling.png" alt="Daily CitiBike usage and average demand per station (30-day rolling mean)"> -->
    <em>[Figure: Top panel – daily CitiBike usage (30-day rolling mean); bottom panel – average daily demand per station (30-day rolling mean)]</em>
  </div>

  <h4>Interpretation</h4>

  <h5>Top panel: Daily CitiBike Usage (30-day Rolling Mean)</h5>
  <ul>
    <li>Usage exhibits strong seasonality, with high demand in summer and substantial slowdowns in winter.</li>
    <li>Demand increases clearly from 2023 to 2024; the increase from 2024 to 2025 is much smaller, indicating a <strong>stagnation in demand growth</strong>.</li>
    <li>Peak summer usage in 2025 is only slightly higher than in 2024, and winter troughs in 2024 and 2025 are nearly identical, reinforcing the stagnation pattern.</li>
    <li>This stagnation suggests CitiBike enters a more <strong>mature phase</strong> where organic growth slows and active measures are needed to boost usage.</li>
  </ul>

  <h5>Bottom panel: Average Daily Demand per Station (30-day Rolling Mean)</h5>
  <ul>
    <li>The same seasonal pattern appears at the station level.</li>
    <li>Per-station usage rises from 2023 to 2024 but shows only minimal increase from 2024 to 2025.</li>
    <li>The near-overlap of the 2024 and 2025 curves indicates that adding more stations alone does not produce substantial per-station demand growth.</li>
    <li>Demand growth flattens: CitiBike’s network is expanding, but <strong>per-station intensity is not</strong>, pointing to the need for demand-boosting interventions.</li>
  </ul>

  <h4>Actionable insights</h4>
  <ol>
    <li>
      <strong>Stimulate winter demand</strong>:
      targeted promotions, discounted rides, or corporate partnerships could smooth the seasonal cycle,
      increase winter ridership, and better utilize fixed infrastructure.
    </li>
    <li>
      <strong>Acquire new users</strong>:
      cooperation with an insurer (e.g., per-ride or membership-based coverage) can reduce perceived risk
      and help bring in current non-users, supporting growth beyond simply expanding the station network.
    </li>
  </ol>

  <!-- 2.2 Net flow (from notebook: "2. Net flow") -->
  <h3>2.2 Net Flow</h3>

  <p>
    For each station \(j\) and day \(t\), we define
  </p>
  <p>
    \[
    \text{NetFlow}_{j,t} = A_{j,t} - D_{j,t},
    \]
  </p>
  <p>
    where \(A_{j,t}\) is the number of arrivals and \(D_{j,t}\) is the number of departures.
    Net flow quantifies how many bikes a station gains or loses over the day.
    Large positive or negative values indicate strong rebalancing needs.
  </p>

  <div class="figure">
    <!-- <img src="src/figures/netflow_abs_and_topstations.png" alt="Average absolute net flow and stations with largest persistent net flow"> -->
    <em>[Figure: Top panel – average absolute net flow per station (30-day rolling mean);
    bottom panel – stations with largest persistent net flow (arrivals − departures)]</em>
  </div>

  <h4>Interpretation</h4>

  <h5>Top panel: Average Absolute Net Flow per Station (Daily, 30-day Rolling Mean)</h5>
  <ul>
    <li>The series shows how unbalanced the system is on any given day, averaged across all stations.</li>
    <li>Average absolute net flow rises to roughly 5+ bikes per station in summer and falls below ~3 in winter, indicating strong seasonal imbalance patterns.</li>
    <li>These patterns repeat consistently in 2023, 2024 and 2025, suggesting predictable cyclical dynamics.</li>
    <li>Short-term spikes reflect operational shocks (e.g., weather events, outages), illustrating that imbalance can also change rapidly.</li>
    <li>Higher average \(|\text{net flow}|\) implies more redistribution work: more truck miles, higher labor costs, and a greater risk of empty/full stations.</li>
    <li>The long-run stability of the curve shows that imbalance is <strong>structural and recurring</strong>, not just random noise.</li>
  </ul>

  <h5>Bottom panel: Stations with Largest Persistent Net Flow (Arrivals − Departures)</h5>
  <ul>
    <li>Some stations consistently exhibit large negative net flow (“net-loss stations”), where bikes are constantly taken and rarely returned.</li>
    <li>Others show strong positive net flow (“net-gain stations”), accumulating bikes that must be removed by staff.</li>
    <li>The magnitude is substantial: several stations average 20–30 bikes per day of net imbalance.</li>
    <li>The list of extreme stations is stable across years, indicating persistent structural sources and sinks in the network.</li>
    <li>These extremes drive a large share of CitiBike’s rebalancing workload, even though most stations remain close to neutral.</li>
  </ul>

  <h4>Actionable insight: Build a net flow prediction model</h4>
  <ol>
    <li><strong>Imbalance is predictable</strong>: strong seasonality and stable station-level patterns mean a model can learn and forecast future imbalances.</li>
    <li><strong>Station-level forecasting</strong> enables targeted redistribution and pre-emptive rebalancing.</li>
    <li>
      <strong>Prevent service disruptions</strong>:
      predicting stations that will run empty or full allows early intervention, reducing lost rides, revenue loss, and customer dissatisfaction.
    </li>
  </ol>

  <!-- 2.3 Usage patterns (from notebook: "3. Usage patterns" + 3.1–3.5) -->
  <h3>2.3 Usage Patterns</h3>

  <p>
    We now examine how usage varies by bike type, membership type, weekday vs weekend, and hour of day, and how trip duration and distance are distributed.
    These patterns are crucial for understanding demand heterogeneity and for designing both operational policies and insurance products.
  </p>

  <h4>2.3.1 Bike vs E-Bike</h4>
  <p>
    We compare classic bikes and e-bikes in terms of their usage shares over time.
  </p>
  <div class="figure">
    <!-- <img src="src/figures/bike_vs_ebike_share.png" alt="Bike vs e-bike usage share over time"> -->
    <em>[Figure: Left – bike type share by year; right – bike type composition over time (monthly share)]</em>
  </div>
  <ul>
    <li>The share of e-bikes has increased markedly over the sample period.</li>
    <li>Classic bikes still account for a substantial fraction of trips, but growth is driven largely by e-bikes.</li>
    <li>The composition is relatively stable month-to-month once the higher e-bike share is established.</li>
  </ul>

  <h4>2.3.2 Member vs Casual</h4>
  <div class="figure">
    <!-- <img src="src/figures/member_vs_casual_share.png" alt="Member vs casual usage over time"> -->
    <em>[Figure: Membership composition over time – monthly share of member vs casual users]</em>
  </div>
  <ul>
    <li>Members account for the majority of trips, but casual riders remain an important segment.</li>
    <li>The relative shares of member and casual users are stable over time, indicating a mature user mix.</li>
    <li>Casual usage is more volatile and peaks in high-demand seasons, making it more sensitive to weather and tourism.</li>
  </ul>

  <h4>2.3.3 Usage by Weekday</h4>
  <div class="figure">
    <!-- <img src="src/figures/weekday_usage_distribution.png" alt="Usage distribution by weekday and its evolution over time"> -->
    <em>[Figure: Left – weekday distribution by year; right – weekday composition over time (monthly shares)]</em>
  </div>
  <ul>
    <li>Weekday trips dominate overall usage, reflecting commuting and regular everyday travel.</li>
    <li>Weekend usage is lower in level but still significant, capturing leisure and tourism use.</li>
    <li>The weekday vs weekend split is remarkably stable over time, suggesting that targeted interventions (e.g., weekend campaigns) could have focused effects.</li>
  </ul>

  <h4>2.3.4 Usage by Hour of Day</h4>
  <div class="figure">
    <!-- <img src="src/figures/hourly_usage_distribution.png" alt="Hourly usage distribution and its evolution over time"> -->
    <em>[Figure: Left – hourly usage distribution by year; right – hourly composition over time (monthly shares)]</em>
  </div>
  <ul>
    <li>Usage peaks during typical commuting hours, with strong morning and evening ridership peaks.</li>
    <li>Midday usage is also substantial, reflecting errands and flexible working patterns.</li>
    <li>The hourly profile is extremely stable across years, providing robust structure for operational planning and prediction.</li>
    <li>The right panel shows that this hourly pattern persists over time; relative shares by hour fluctuate only slightly month-to-month.</li>
  </ul>

  <h4>2.3.5 Duration and Distance per Usage</h4>
  <p>
    Finally, we examine trip duration and inferred distance distributions.
  </p>
  <div class="figure">
    <!-- <img src="src/figures/trip_duration_distance.png" alt="Trip duration and distance distributions"> -->
    <em>[Figure: Top – trip duration distribution; bottom – trip distance distribution]</em>
  </div>
  <ul>
    <li>Trip durations are sharply peaked around short rides (roughly 10–20 minutes), with very few trips exceeding 30–40 minutes.</li>
    <li>Trip distances peak around 1–2 km, with a thin right tail beyond ~5 km.</li>
    <li>This confirms that CitiBike is predominantly used for short urban trips, which is important for outage risk, maintenance planning, and insurance exposure.</li>
  </ul>

  <h4>Actionable insights from usage patterns</h4>
  <ul>
    <li><strong>Fleet composition</strong>: the strong and growing role of e-bikes may justify prioritizing e-bike availability at key stations and times.</li>
    <li><strong>Targeted interventions</strong>: stable patterns by weekday, weekend and hour provide clear windows for campaigns (e.g., off-peak promotions, weekend offers).</li>
    <li><strong>Risk exposure</strong>: typical ride durations and distances help quantify exposure for per-ride insurance products and for station-level risk assessment.</li>
  </ul>

  <!-- 2.4 Conclusion (from notebook: "4. Conclusion") -->
  <h3>2.4 Summary</h3>
  <ul>
    <li>Demand shows clear seasonal patterns and signs of stagnating growth between 2024 and 2025, especially in per-station usage.</li>
    <li>Net flow patterns are structural and persistent, pointing to recurring rebalancing needs at a subset of stations.</li>
    <li>Usage by bike type, membership, weekday/weekend and hour is highly structured and stable over time.</li>
    <li>Trips are short in duration and distance, shaping both operational needs and the nature of risk exposure.</li>
  </ul>
</section>


  <!-- 3. Risk Analysis -->
<section id="risk-analysis">
  <h2>3. Risk Analysis</h2>

  <p>
    We combine CitiBike trip data with NYPD collision records to quantify safety risks around CitiBike stations.
    Our goals are to:
  </p>
  <ol>
    <li><strong>warn users</strong> when renting from high-risk stations,</li>
    <li><strong>inform insurers</strong> about expected loss per trip, and</li>
    <li><strong>identify hazardous areas</strong> where CitiBike can advocate for safety improvements.</li>
  </ol>

  <h3>3.1 Assigning Crashes to Stations</h3>
  <p>
    Each crash is assigned to the nearest CitiBike station using a <strong>BallTree</strong> with a
    <strong>Haversine distance metric</strong>:
  </p>
  <p>
    \[
    d\bigl((\text{lat}_i,\text{lon}_i), (\text{lat}_j,\text{lon}_j)\bigr),
    \]
  </p>
  <p>
    where \((\text{lat}_i,\text{lon}_i)\) is the crash location and \((\text{lat}_j,\text{lon}_j)\) is the station location.
    We restrict to crashes within 300m of a station. Crashes further away are unlikely to be directly relevant for CitiBike trips.
  </p>
  <p>
    This assignment step links collision risk to specific stations and allows us to compute risk per CitiBike trip.
  </p>

  <h3>3.2 Conceptual Definition of the Risk Measure</h3>
  <p>
    For each station \(j\) and time bucket \(b\) (e.g., day or a time-of-day × weekday cell), we define:
  </p>
  <ul>
    <li>\(H_{j,b}\): the total crash <em>hazard</em> (severity) assigned to station \(j\) in bucket \(b\),</li>
    <li>\(E_{j,b}\): the number of CitiBike trips starting at station \(j\) in bucket \(b\) (exposure),</li>
    <li>\(\epsilon > 0\): a small constant to avoid division by zero.</li>
  </ul>
  <p>
    The <strong>raw risk per trip</strong> is
  </p>
  <p>
    \[
      R_{j,b} = \frac{H_{j,b}}{E_{j,b} + \epsilon}.
    \]
  </p>
  <p>
    Because exposure varies widely across stations and times, the raw ratio \(R_{j,b}\) can be noisy, especially when
    \(E_{j,b}\) is small. To stabilize the estimates, we apply <strong>Empirical Bayes (EB) smoothing</strong>:
  </p>
  <p>
    \[
      R_{j,b}^{\text{EB}} = \lambda_{j,b} R_{j,b} + (1 - \lambda_{j,b}) \mu,
    \]
  </p>
  <p>
    where:
  </p>
  <ul>
    <li>\(\mu\) is a global mean risk (or a time-of-day specific mean),</li>
    <li>\(\lambda_{j,b} = \dfrac{E_{j,b}}{E_{j,b} + C}\) is the credibility weight,</li>
    <li>\(C > 0\) is a credibility constant.</li>
  </ul>
  <p>
    Interpretation:
  </p>
  <ul>
    <li>Large \(E_{j,b}\) (many trips) ⇒ \(\lambda_{j,b} \approx 1\), so \(R_{j,b}^{\text{EB}} \approx R_{j,b}\): we trust station–time specific data.</li>
    <li>Small \(E_{j,b}\) (few trips) ⇒ \(\lambda_{j,b} \approx 0\), so \(R_{j,b}^{\text{EB}} \approx \mu\): we shrink towards the overall mean.</li>
  </ul>
  <p>
    This yields a stable, interpretable measure of expected crash severity per trip that we can aggregate:
  </p>
  <ul>
    <li><strong>Station-level risk</strong> by summing over time buckets,</li>
    <li><strong>Temporal risk</strong> by aggregating across stations,</li>
    <li><strong>Station × time-of-day risk</strong> as the most granular product.</li>
  </ul>

  <h3>3.3 Crash Severity</h3>
  <p>
    The hazard component is built from a crash-level severity score \(S_i\) that satisfies:
  </p>
  <ol>
    <li>Cyclist-involved crashes matter much more than other crashes.</li>
    <li>Injuries make a crash substantially more severe than property-damage-only events.</li>
    <li>Fatalities are treated as much more severe than injuries.</li>
  </ol>

  <p>Let:</p>
  <ul>
    <li>\(\text{injured}_i\) = number of persons injured in crash \(i\),</li>
    <li>\(\text{killed}_i\) = number of persons killed in crash \(i\),</li>
    <li>\(\text{cyclist}_i \in \{0,1\}\) = 1 if a cyclist was involved.</li>
  </ul>

  <p>We define</p>
  <p>
    \[
    S_i
    =
    \Bigl( 1 + W_I \cdot \text{injured}_i + W_K \cdot \text{killed}_i \Bigr)
    \cdot
    \Bigl( \alpha + (1 - \alpha)\,\text{cyclist}_i \Bigr),
    \]
  </p>
  <p>
    where:
  </p>
  <ul>
    <li>\(W_I\) and \(W_K\) weight injuries and fatalities, respectively,</li>
    <li>\(\alpha \in (0,1)\) down-weights crashes without cyclists.</li>
  </ul>

  <p>In the baseline specification:</p>
  <ul>
    <li>\(W_I = 5\), \(W_K = 20\),</li>
    <li>\(\alpha = 0.1\).</li>
  </ul>

  <p>
    This means:
  </p>
  <ul>
    <li>a cyclist crash is roughly 10× a comparable non-cyclist crash,</li>
    <li>injuries and fatalities are strongly up-weighted.</li>
  </ul>
  <p>
    The hazard measure therefore:
  </p>
  <ul>
    <li>does <strong>not ignore non-cyclist crashes</strong>, capturing general traffic risk,</li>
    <li>but <strong>strongly emphasizes cyclist-involved and severe crashes</strong>, which is key for CitiBike users and insurers.</li>
  </ul>

  <h3>3.4 Station-Level Risk</h3>
  <p>
    At the <strong>station level</strong>, we aggregate hazard and exposure over time to compute a smoothed risk measure
    \(R_{j}^{\text{EB}}\) for each station \(j\).
  </p>

  <div class="figure">
    <!-- <iframe src="src/figures/station_risk_tiers.html" ... ></iframe> -->
    <em>[Figure: Map of CitiBike stations colored by station-level smoothed risk \(R_{j}^{\text{EB}}\)]</em>
  </div>

  <h4>Interpretation, Implications, Opportunities, Strategy</h4>
  <ul>
    <li>
      <strong>Low-risk clusters</strong>:
      large groups of stations with low \(R_{j}^{\text{EB}}\) (e.g., quiet residential areas, well-protected corridors)
      where crash risk per trip is small.
    </li>
    <li>
      <strong>Medium-risk corridors</strong>:
      stations along busy arterials and mixed-traffic routes with elevated but not extreme risk.
    </li>
    <li>
      <strong>High and very-high risk hotspots</strong>:
      stations at or near complex intersections, high-speed roads, or poorly protected cycling infrastructure.
    </li>
    <li>
      Persistent high-risk stations are natural targets for infrastructure improvements, enforcement,
      and user-facing warnings (e.g., in the app).
    </li>
  </ul>

  <p>
    Strategically, station-level risk can be used to:
  </p>
  <ul>
    <li>prioritize safety investments (e.g., protected lanes, traffic calming),</li>
    <li>signal risk to users at checkout (e.g., “higher-than-average crash risk at this station”),</li>
    <li>form the basis of station-level risk modifiers in insurance pricing.</li>
  </ul>

  <h3>3.5 Time-of-Day Risk</h3>
  <p>
    We now examine <strong>when</strong> riding is most dangerous by aggregating hazard and exposure across stations
    and focusing on time-of-day (and weekday vs weekend) buckets.
  </p>

  <div class="figure">
    <!-- <img src="src/figures/risk_tod_weekday.png" alt="Time-of-day and weekday risk"> -->
    <em>[Figure: Smoothed risk \(R_{b}^{\text{EB}}\) by time-of-day and weekday/weekend]</em>
  </div>

  <h4>Time-of-Day & Weekday Risk: Interpretation, Implications, Opportunities, Strategy</h4>
  <ul>
    <li>Risk per trip tends to be elevated in the <strong>evening and late evening</strong>, consistent with reduced visibility, higher car speeds, and nightlife traffic.</li>
    <li>Nighttime risk is higher relative to daytime, even though absolute demand is lower.</li>
    <li>There are differences between weekdays and weekends, reflecting changes in traffic composition (commuters vs leisure traffic and tourism).</li>
    <li>Temporal risk patterns are relatively stable over time, meaning they can be used reliably in pricing and communication.</li>
  </ul>

  <p><strong>Implications</strong></p>
  <ul>
    <li>From an insurance perspective, evening and nighttime trips carry a higher expected loss per ride.</li>
    <li>For CitiBike, communication and safety campaigns can be focused on high-risk times, not just high-risk locations.</li>
  </ul>

  <p><strong>Operational opportunities</strong></p>
  <ul>
    <li>Offer incentives to shift some trips from high-risk time windows to lower-risk windows where feasible.</li>
    <li>Align rebalancing and maintenance activities to avoid unnecessary exposure during the riskiest periods.</li>
  </ul>

  <p><strong>Strategic takeaway</strong></p>
  <ul>
    <li>The temporal risk landscape is shaped mostly by time-of-day (and to a lesser extent weekday vs weekend),
    and these patterns are predictable; they should be built into both pricing and rider communication.</li>
  </ul>

  <h3>3.6 Station × Time-of-Day Risk</h3>
  <p>
    The most granular view combines <strong>where</strong> and <strong>when</strong>.
    For each station \(j\) and time-of-day bucket \(t\) (aggregating over weekdays), we define:
  </p>
  <ul>
    <li>Station–time hazard:
      \[
      H_{j,t} = \sum_{b \in t} H_{j,b},
      \]
    </li>
    <li>Station–time exposure:
      \[
      E_{j,t} = \sum_{b \in t} E_{j,b}.
      \]
    </li>
  </ul>

  <p>
    The raw station–time risk is
  </p>
  <p>
    \[
      R_{j,t} = \frac{H_{j,t}}{E_{j,t} + \epsilon}.
    \]
  </p>

  <p>
    We smooth <strong>within each time-of-day</strong> using a time-specific mean \(\mu_t\):
  </p>
  <p>
    \[
    R_{j,t}^{\text{EB}} = \lambda_{j,t} R_{j,t} + (1 - \lambda_{j,t}) \mu_t,
    \quad
    \lambda_{j,t} = \frac{E_{j,t}}{E_{j,t} + C},
    \]
  </p>
  <p>
    where
  </p>
  <p>
    \[
      \mu_t = \frac{\sum_j H_{j,t}}{\sum_j E_{j,t}}.
    \]
  </p>

  <p>
    This yields a stable station × time-of-day risk measure \(R_{j,t}^{\text{EB}}\) that captures how risk varies both across space and across the day.
  </p>

  <div class="figure">
    <!-- <img src="src/figures/station_tod_risk_grid.png" alt="Station × time-of-day risk grid"> -->
    <em>[Figure: Heatmap or grid of station × time-of-day smoothed risk \(R_{j,t}^{\text{EB}}\)]</em>
  </div>

  <h4>Interpretation, Implications, Opportunities, Strategy</h4>
  <ul>
    <li>Some stations are consistently low-risk across all times of day.</li>
    <li>Others are low-risk during the day but high-risk at night or in specific time windows.</li>
    <li>There are stations that appear moderate in station-level averages but exhibit <strong>very high nighttime risk</strong>,
    which would be missed by aggregate views.</li>
    <li>These station × time-of-day patterns are essential for targeted interventions and for fine-grained risk pricing.</li>
  </ul>

  <h3>3.7 How an Insurer Can Use the Station × Time-of-Day Risk Measure</h3>
  <ul>
    <li><strong>Pricing</strong>:
      \ul>
        <li>Use \(R_{j,t}^{\text{EB}}\) as a rating factor for per-ride or membership-based insurance.</li>
        <li>Lower rates for low-risk stations and time windows (e.g., midday at low-risk stations).</li>
        <li>Higher rates for high-risk stations and times (e.g., late evening at identified hotspots).</li>
      </ul>
    </li>
    <li><strong>Identification of high-severity, low-frequency pockets</strong>:
      stations that look benign in aggregate but exhibit very high risk at specific times can be flagged for special attention.
    </li>
    <li><strong>Portfolio management</strong>:
      monitor expected loss contributions by station cluster, time-of-day, or combination segments;
      design reinsurance or internal limits for high-risk parts of the portfolio.
    </li>
    <li><strong>Collaborative risk mitigation</strong>:
      co-fund infrastructure improvements and rider safety campaigns at persistent hotspots and high-risk times,
      reducing risk over time for both CitiBike and the insurer.
    </li>
  </ul>

  <p>
    <strong>Strategic takeaway for insurers:</strong>
    the risk measure provides a granular, interpretable input into modern actuarial modeling and supports fair pricing,
    risk monitoring, and targeted mitigation, rather than crude, system-wide averages.
  </p>
</section>


  <!-- 4. Net Flow Prediction -->
<section id="net-flow">
  <h2>4. Net Flow Prediction</h2>

  <p>
    Net flow is a key operational indicator for CitiBike. For each station \(j\) and day \(t\), we define:
  </p>

  <p>
    \[
      \text{NetFlow}_{j,t} = A_{j,t} - D_{j,t},
    \]
  </p>

  <p>
    where \(A_{j,t}\) is the number of arrivals and \(D_{j,t}\) is the number of departures.  
    A positive value means the station tends to <em>fill up</em>, while a negative value means it tends to
    <em>empty out</em>. Correctly anticipating these imbalances is crucial for rebalancing, avoiding empty/full stations, 
    and ensuring consistent rider experience.
  </p>

  <h3>4.1 Exploratory Analysis: Understanding Net Flow Dynamics</h3>

  <p>
    As a first step, we compute daily station-level net flows for all active stations across 2023–2025.
    The exploratory analysis in the notebook reveals several important patterns:
  </p>

  <h4>4.1.1 Station-Level Structure</h4>

  <ul>
    <li>
      Most stations have net flows close to zero on most days, meaning arrivals and departures nearly balance.
    </li>
    <li>
      A subset of stations exhibit consistently large positive or negative net flow, often corresponding to strong 
      <strong>sources</strong> (morning departures from residential areas) or <strong>sinks</strong> 
      (arrivals near offices or transit hubs).
    </li>
    <li>
      These source–sink patterns are highly persistent across years, indicating strong structural spatial dynamics.
    </li>
  </ul>

  <div class="figure">
    <em>[Figure: Histogram of net flows across all station-days. The distribution is sharply peaked at 0, with heavy tails.]</em>
  </div>

  <h4>4.1.2 Why Prediction is Challenging</h4>

  <p>
    The distribution of \(\text{NetFlow}_{j,t}\) has two problematic features:
  </p>

  <ul>
    <li><strong>Most values lie within a narrow band around zero</strong>, making regression models dominated by the "balanced" cases.</li>
    <li><strong>The tails contain the operationally important events</strong> — large positive or negative imbalances — which occur relatively infrequently.</li>
  </ul>

  <p>
    Therefore, predicting the exact numerical value of net flow is difficult and may not be the right objective.
  </p>

  <div class="callout">
    <strong>Key insight from the EDA:</strong>  
    The operational value lies in <em>detecting when a station is likely to become significantly imbalanced</em>, 
    not in predicting the exact net flow number.
  </div>

  <h3>4.2 Problem Formulation: Ternary Imbalance Classification</h3>

  <p>
    Based on the distributional insights, we define a three-class (ternary) classification problem.
    For each station-day \((j,t)\), we assign:
  </p>

  <p>
    \[
      y_{j,t} =
      \begin{cases}
        -1, & \text{if } \text{NetFlow}_{j,t} < -5, \\
         0, & \text{if } |\text{NetFlow}_{j,t}| \le 5, \\
         +1, & \text{if } \text{NetFlow}_{j,t} > 5.
      \end{cases}
    \]
  </p>

  <p>
    The ±5 threshold reflects the approximate scale at which stations start experiencing meaningful operational pressure — 
    becoming either too empty or too full during the day.
  </p>

  <p>
    This framing turns the problem into predicting:
  </p>

  <ul>
    <li><strong>Under-supply (−1):</strong> stations likely to run empty by the end of the day.</li>
    <li><strong>Balanced (0):</strong> stations with mild or negligible imbalance.</li>
    <li><strong>Over-supply (+1):</strong> stations likely to accumulate too many bikes.</li>
  </ul>

  <p>
    This classification view aligns closely with operational decision-making, and the labels are well balanced in practice:
    while the majority falls in the balanced class, a meaningful fraction falls into the under- and over-supply categories, 
    providing the model with enough signal to learn.
  </p>

  <h3>4.3 Feature Engineering</h3>

  <p>
    Because net flow exhibits strong temporal and spatial structure, we construct a set of robust, interpretable features
    that capture both short-term dynamics and long-run seasonality. For each station-day \((j,t)\), we include:
  </p>

  <h4>4.3.1 Temporal Net Flow Features</h4>

  <ul>
    <li><strong>Lag-1 net flow</strong>: \(\text{NetFlow}_{j,t-1}\)</li>
    <li><strong>Lag-7 net flow</strong> (same weekday): \(\text{NetFlow}_{j,t-7}\)</li>
    <li><strong>3-day rolling mean</strong> of net flow</li>
  </ul>

  <p>
    These features capture both daily inertia and weekly rhythm (office commuters, school patterns, etc.).
  </p>

  <h4>4.3.2 Calendar Features</h4>

  <ul>
    <li><strong>Weekday / weekend</strong></li>
    <li><strong>Month of year</strong> (seasonal effects)</li>
    <li><strong>Day-of-month</strong> and <strong>year</strong></li>
  </ul>

  <p>
    Demand patterns and imbalance cycles have strong seasonal components, making these features essential.
  </p>

  <h4>4.3.3 Station Features</h4>

  <ul>
    <li><strong>Latitude</strong> and <strong>longitude</strong></li>
    <li>(If available later) <strong>station capacity</strong>, <strong>distance to subway</strong>, or <strong>land-use indicators</strong></li>
  </ul>

  <p>
    Spatial location is a major determinant of net flow. Even without explicit land-use data, latitude/longitude capture 
    meaningful spatial clusters (residential vs business districts).
  </p>

  <h4>4.3.4 Weather Features (Lagged)</h4>

  <p>
    Because the goal is to <strong>predict tomorrow</strong>, tomorrow’s weather is not known at prediction time.
    Therefore, we include:
  </p>

  <ul>
    <li><strong>Yesterday’s temperature</strong></li>
    <li><strong>Yesterday’s precipitation</strong> (rain, snow)</li>
  </ul>

  <p>
    Weather has inertia: conditions on day \(t-1\) influence riding on day \(t\),
    and lagged weather is observationally predictive even without future forecasts.
  </p>

  <div class="callout">
    <strong>Modeling principle:</strong>  
    All features are strictly backward-looking and available at prediction time, ensuring the model is operationally feasible.
  </div>

  <h3>4.4 Modeling Framework</h3>

  <p>
    We use a supervised classification framework to predict the label \(y_{j,t} \in \{-1,0,+1\}\).
    Candidate models include:
  </p>

  <ul>
    <li><strong>Gradient-boosted decision trees</strong> (XGBoost, LightGBM)</li>
    <li><strong>Random Forest</strong></li>
    <li><strong>Regularized logistic regression</strong> (for interpretability)</li>
  </ul>

  <p>
    Tree-based models are preferred for:
  </p>

  <ul>
    <li>nonlinear interactions (e.g., “lag-7 net flow matters more on Mondays”),</li>
    <li>handling skewed distributions,</li>
    <li>strong performance with mixed numerical/categorical features.</li>
  </ul>

  <p>
    The target is imbalanced but not overwhelmingly so.  
    To address class imbalance, we consider:
  </p>

  <ul>
    <li><strong>class weighting</strong> (e.g. lower weight for the balanced class),</li>
    <li><strong>macro F1-score</strong> as evaluation metric,</li>
    <li><strong>threshold tuning</strong> to control false negatives for critical classes (emptying or filling stations).</li>
  </ul>

  <h3>4.5 Operational Value of Net Flow Prediction</h3>

  <p>
    A well-calibrated net flow classifier enables CitiBike to:
  </p>

  <ul>
    <li>
      <strong>Proactively rebalance</strong>:
      identify tomorrow’s stations that will need rebalancing early, improving truck routing and staff planning.
    </li>
    <li>
      <strong>Prevent service failures</strong>:
      stations predicted to empty or fill can be addressed before riders experience outages.
    </li>
    <li>
      <strong>Reduce operational costs</strong>:
      targeted redistribution is vastly more efficient than reactive redistribution.
    </li>
    <li>
      <strong>Improve rider experience</strong>:
      fewer “no bikes available” or “no docks available” events.
    </li>
  </ul>

  <h3>4.6 Next Steps</h3>

  <ul>
    <li>
      Incorporate additional weather forecasts to refine uncertainty for future days (optional).
    </li>
    <li>
      Add <strong>station capacity</strong> and <strong>land-use descriptors</strong> to improve spatial modeling.
    </li>
    <li>
      Evaluate classification performance across seasons: winter vs summer accuracy may differ.
    </li>
    <li>
      Integrate predictions into a <strong>dispatch dashboard</strong> for rebalancing teams.
    </li>
  </ul>

</section>


  <!-- 5. Conclusion -->
  <section id="conclusion">
    <h2>5. Conclusion &amp; Strategic Takeaways</h2>

    <h3>5.1 Summary</h3>
    <ul>
      <li>CitiBike usage exhibits strong seasonality and signs of recent growth stagnation, especially in per-station demand.</li>
      <li>Trips are short and highly predictable in duration and distance, which is favorable for modeling and risk assessment.</li>
      <li>The constructed risk measure provides a <strong>granular, interpretable</strong> view of crash risk per trip, by station and time-of-day.</li>
      <li>Net flow patterns are stable and structured, suggesting that predictive models can meaningfully support rebalancing.</li>
    </ul>

    <h3>5.2 Value for CitiBike and an Insurance Partner</h3>
    <ul>
      <li><strong>For CitiBike</strong>:
        <ul>
          <li>Identify stations and times with elevated risk and target infrastructure or informational interventions.</li>
          <li>Use net flow predictions to improve service reliability and reduce operational costs.</li>
        </ul>
      </li>
      <li><strong>For an insurer</strong>:
        <ul>
          <li>Use $R_{j,b}^{\text{EB}}$ as a risk factor for pricing per-ride or membership insurance for riders.</li>
          <li>Monitor portfolio risk across space and time, and design reinsurance or risk limits where needed.</li>
        </ul>
      </li>
      <li><strong>For both</strong>:
        <ul>
          <li>Develop joint, data-driven safety initiatives at high-risk stations and times.</li>
          <li>Communicate transparent, quantitative risk information to riders (e.g., “higher risk at this station at night”).</li>
        </ul>
      </li>
    </ul>

    <h3>5.3 Next Steps</h3>
    <p>
      Immediate next steps include:
    </p>
    <ul>
      <li>Finalizing and validating the net flow prediction model.</li>
      <li>Refining the risk measure (e.g., alternative severity weights, additional covariates).</li>
      <li>Prototyping a <strong>web app</strong> where stakeholders can explore demand and risk interactively by station, time, and scenario.</li>
    </ul>
  </section>

</main>

</body>
</html>
